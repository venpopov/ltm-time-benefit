{
  "hash": "96f2b9658ea2b6221e81669dbcbd518c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Linear recovery as a random variable\"\nformat: html\nauthor: \"Ven Popov\"\ndate: 05/27/2024\ndate-modified: 05/28/2024\n---\n\n\n\n\n\n\n## Overview\n\nIn the simulations we have considered two different equations for the recovery of resources over time:\n\n#### Linear recovery\n\nResources recover linearly over time at a constant rate `r` until they reach a maximum value of 1:\n\n$$\nR_{new} = \\min(1, R + r \\cdot t)\n$$\n\nwhere $R$ is the resource level before recovery, $t$ is the recovery duration, and $r$ is the recovery rate.\n\n#### Exponential recovery\n\nAlternatively, resources could recover non-linearly over time at a rate that depends on the current resource level:\n\n$$\nR_{new} = R + (1 - R) \\cdot (1 - e^{-r t}) = 1 - (1 - R)e^{-r t}\n$$\n\nwhich can be simplified in the case of recovery starting from 0 to\n\n$$\nR(t) = 1 - e^{-r t}\n$$\n\nKlaus and I discussed the possibility that the recovery is linear, but the rate of recovery `r` is a random variable that varies over trials and individuals. Similarly to the evidence accumulation rate in the linear balistic accumulator models, at the aggregate level the recovery rate might be better modeled with the exponential recovery equation, even if the individual recovery is linear. In this notebook, I explore this idea further and derive analytical solutions for the average recovery over time under different assumptions about the distribution of `r`.\n\n\n\n## Linear recovery with a random variable rate\n\nAssume that resource recover linearly over time at a constant rate `r` until they reach a maximum value of 1. Assume that `r` is a random variable. Let's plot the average resource recovery over time under different assumptions about the distribution of `r`.\n\n\n\n\n::: {.cell .fig-column-margin}\n\n```{.r .cell-code}\npar(mar = c(4, 0.5, 2, 1), lwd = 2)\ncurve(\n  dunif(x, 0, 1),\n  from = 0, to = 4, n = 1001, col = \"black\",\n  xlab = \"r\", ylab = NA, main = \"Distribution of r\",\n  ylim = c(0, 1.5), yaxt = \"n\",\n)\ncurve(\n  truncnorm::dtruncnorm(x, a = 0, mean = 0.5, sd = 0.3),\n  from = 0, to = 4, n = 1001, col = \"red\", add = TRUE\n)\ncurve(\n  dgamma(x, shape = 1, scale = 1),\n  from = 0, to = 4, n = 1001, col = \"blue\", add = TRUE\n)\ncurve(\n  dgamma(x, shape = 3, rate = 5),\n  from = 0, to = 4, n = 1001, col = \"orange\", add = TRUE\n)\n# add legend\nlegend(\"topright\",\n  legend = c(\"Uniform(0, 1)\", \"Normal(0.5, 0.3)\", \"Exp(1)\", \"Gamma(3, 5)\"),\n  col = c(\"black\", \"red\", \"blue\", \"orange\"), lty = 1\n)\n```\n\n::: {.cell-output-display}\n![](linear-recovery-random-variable_files/figure-html/unnamed-chunk-1-1.png){width=336}\n:::\n:::\n\n\n\n\n1. `r` is uniformly distributed between 0 and 1.\n2. `r` is distributed as a truncated normal distribution with mean 0.5 and standard deviation 0.3\n3. `r` is distributed as an exponential distribution with rate 1\n4. `r` is distributed as a gamma distribution with shape 3 and rate 5\n\nRed line shows the average recovery over time. Black lines show individual trajectories of a few random samples of `r`. The full distributions of `r` are shown in the margin.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(3)\nn <- 1000\nr_unif <- runif(n, 0, 1)\nr_truncnorm <- truncnorm::rtruncnorm(n, a = 0, mean = 0.5, sd = 0.3)\nr_exp <- rgamma(n, shape = 1, scale = 1)\nr_gamma <- rgamma(n, shape = 3, rate = 5)\nt <- seq(0, 5, length.out = 100)\n\nplot_linear_rv_recovery(r_unif, t, title = \"r ~ Uniform(0, 1)\") + \n  plot_linear_rv_recovery(r_truncnorm, t, title = \"r ~ Normal(0.5, 0.3), r >= 0\") +\n  plot_linear_rv_recovery(r_exp, t, \"r ~ Exp(1)\") + \n  plot_linear_rv_recovery(r_gamma, t, \"r ~ Gamma(3, 5)\")\n```\n\n::: {.cell-output-display}\n![](linear-recovery-random-variable_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n## Analytical solutions for the average recovery over time\n\nFor simplicity, consider the case of recovery starting from 0. Given a continuous distribution of `r`, $f(r)$, we can derive the average recovery over time by integrating two separate quantites over all possible values of `r`. We have to consider two cases:\n\n1. Resources have not yet reached their maximum value of 1 and are recovering linearly at a rate `r`. This is the case for $r < 1/t$\n2. Resources have reached their maximum value of 1 and are no longer recovering. This is the case for $r \\geq 1/t$\n\nThe average recovery after time `t` is then given by the following combination of integrals:\n\n$$\nR(t) = \\int_{0}^{1/t} r \\cdot t \\cdot f(r) \\, dr + \\int_{1/t}^{\\infty} 1 \\cdot f(r) \\, dr  \n$$\n\nBelow I give the solution for the exponential and gamma distributions of `r`.\n\n### Exponential distribution\n\nLet's consider the case where `r` is distributed as an exponential distribution with rate $\\lambda$. The probability density function of the exponential distribution is given by\n\n$$\nf(r) = \\lambda e^{-\\lambda r}\n$$\n\nThe average recovery over time is then given by\n\n\\begin{aligned}\nR(t) &= \\int_{0}^{1/t} r \\cdot t \\cdot \\lambda e^{-\\lambda r} \\, dr + \\int_{1/t}^{\\infty} 1 \\cdot \\lambda e^{-\\lambda r} \\, dr \\\\\n&= \\left[ -\\frac{t e^{\\lambda  (-r)} (\\lambda  r+1)}{\\lambda } \\right]_{0}^{1/t} + \\left[ -e^{-\\lambda r} \\right]_{1/t}^{\\infty} \\\\\n&= \\frac{t-e^{-\\lambda / t} (\\lambda +t)}{\\lambda } + e^{-\\lambda / t} \\\\\n&= \\frac{t}{\\lambda} (1 - e^{-\\lambda/t})\n\\end{aligned}\n\n### Gamma distribution\n\nThe probability density function of the gamma distribution is given by\n\n$$\nf(r) = \\frac{\\lambda^{\\alpha} r^{\\alpha - 1} e^{-\\lambda r}}{\\Gamma(\\alpha)}\n$$\n\nwhere $\\alpha$ is the shape parameter and $\\lambda$ is the rate parameter. The average recovery over time is then given by\n\n\\begin{aligned}\nR(t) &= \\int_{0}^{1/t} r \\cdot t \\cdot \\frac{\\lambda^{\\alpha} r^{\\alpha - 1} e^{-\\lambda r}}{\\Gamma(\\alpha)} \\, dr + \\int_{1/t}^{\\infty} 1 \\cdot \\frac{\\lambda^{\\alpha} r^{\\alpha - 1} e^{-\\lambda r}}{\\Gamma(\\alpha)} \\, dr \\\\\n&= \\frac{\\lambda^{\\alpha}}{\\Gamma(\\alpha)} \\left( t \\int_{0}^{1/t} r^{\\alpha} e^{-\\lambda r} \\, dr + \\int_{1/t}^{\\infty} r^{\\alpha - 1} e^{-\\lambda r} \\, dr \\right) \\\\\n\n\\end{aligned}\n\nwhich after some transformations can be written as\n\n$$\n\\begin{aligned}\nR(t) &= \\frac{\\Gamma \\left(\\alpha ,\\frac{\\lambda }{t}\\right)}{\\Gamma (\\alpha )}-\\frac{\\alpha t}{\\lambda}\\frac{\\Gamma \\left(\\alpha +1,\\frac{\\lambda }{t}\\right)}{\\Gamma (\\alpha +1)}+\\frac{\\alpha  t}{\\lambda} \\\\\n&= \\frac{\\Gamma \\left(\\alpha ,\\frac{\\lambda }{t}\\right)}{\\Gamma (\\alpha )}-\\frac{\\alpha t}{\\lambda}\\left(1-\\frac{\\Gamma \\left(\\alpha +1,\\frac{\\lambda }{t}\\right)}{\\Gamma (\\alpha +1)}\\right) \\\\\n&= \\frac{\\Gamma \\left(\\alpha ,\\frac{\\lambda }{t}\\right)}{\\Gamma (\\alpha )}-\\frac{\\alpha t}{\\lambda}\\frac{\\gamma \\left(\\alpha +1,\\frac{\\lambda }{t}\\right)}{\\Gamma (\\alpha +1)} \\\\\n&= P(\\alpha, \\lambda / t) - \\frac{\\alpha t}{\\lambda} Q(\\alpha + 1, \\lambda / t)\n\\end{aligned}\n$$\n\nwhere $\\Gamma(a, z)$ is the [upper incomplete gamma function](https://mathworld.wolfram.com/IncompleteGammaFunction.html), $\\gamma(a, z)$ is the lower incomplete gamma function; and $P(a, z)$ and $Q(a, z)$ are the regularized upper and lower incomplete gamma functions, respectively. P and Q are respectively the complimentary cdf and the cdf of the gamma distribution. They can be computed using the `pgamma` function in R with the `lower.tail = FALSE` argument for the upper incomplete gamma function and the `pgamma` function with the `lower.tail = TRUE` argument for the lower incomplete gamma function.\n\n## Compare with exponential recovery\n\nThe equations derived above under the assumption of an exponential or gamma distribution of `r` are obviously not the same as the exponential recovery equation. But is the exponential recovery equation a good approximation of the average recovery over time when `r` is a random variable following an exponential or gamma distribution?\n\nIn this part, I compare the recovery given by the exponential recovery equation with the recovery given by the marginalized linear recovery with `r` following an exponential distribution or gamma distribution. I will use the analytical solutions derived above to fit the parameters of the exponential and gamma distributions to the exponential recovery equation.\n\nLet's define our functions:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nexp_recovery <- function(r, t) {\n  1 - exp(-r * t)\n}\n\nmarginal_recovery_exponential <- function(lambda, t) {\n  t/lambda * (1 - exp(-lambda/t))\n}\n\nmarginal_recovery_gamma <- function(alpha, lambda, t) {\n  P <- pgamma(lambda / t, shape = alpha, lower.tail = FALSE) \n  R <- pgamma(lambda / t, shape = alpha + 1)\n  P + alpha * t / lambda * R\n}\n```\n:::\n\n\n\n\n\n### Marginal recovery from an exponential distribution\n\nSet the true recovery rate to 0.3 and fit the rate parameter of the exponential distribution to the exponential recovery equation.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nobjective_fn <- function(log_lambda, t, target) {\n  pred <- marginal_recovery_exponential(exp(log_lambda), t)\n  sqrt(mean((pred - target)^2))\n}\n\nset.seed(2)\ntrue_r <- 0.3\nt <- seq(0, 60, length.out = 1000)\nfit <- optim(1, objective_fn, t = t, target = exp_recovery(true_r, t))\nlambda <- exp(fit$par)\n\ncurve(\n  marginal_recovery_exponential(lambda, t),\n  from = 0, to = 20, n = 1001,\n  col = \"blue\", ylim = c(0, 1), xname = \"t\", ylab = \"R(t)\"\n)\ncurve(\n  exp_recovery(true_r, t),\n  col = \"red\", add = TRUE, xname = \"t\"\n)\nlegend(\"bottomright\", legend = c(\"Marginal linear recovery\\n(rate is an exponential random variable)\", \"Exponential recovery\"), col = c(\"blue\", \"red\"), lty = 1)\n```\n\n::: {.cell-output-display}\n![](linear-recovery-random-variable_files/figure-html/unnamed-chunk-4-1.png){width=528}\n:::\n:::\n\n\n\n\nThe overall shape is similar, but the approximation is not great. \n\n### Marginal recovery from a gamma distribution\n\nThe approximation when the rate follows a gamma distribution is much better::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nobjective_fn <- function(pars, t, target) {\n  pred <- marginal_recovery_gamma(exp(pars[1]), exp(pars[2]), t)\n  sqrt(mean((pred - target)^2))\n}\n\nset.seed(2)\ntrue_r <- 0.30\nt <- seq(0, 200, length.out = 1000)\nfit <- optim(c(0, 0), objective_fn, t = t, target = exp_recovery(true_r, t))\npars <- exp(fit$par)\n\ncurve(\n  marginal_recovery_gamma(pars[1], pars[2], t),\n  from = 0, to = 1 / true_r * 5, n = 1001,\n  col = \"blue\", ylim = c(0, 1), xname = \"t\", ylab = \"R(t)\"\n)\ncurve(\n  exp_recovery(true_r, t),\n  col = \"red\", add = TRUE, xname = \"t\"\n)\nlegend(\"bottomright\", legend = c(\"Marginal linear recovery\\n(rate is a gamma random variable)\", \"Exponential recovery\"), col = c(\"blue\", \"red\"), lty = 1)\n```\n\n::: {.cell-output-display}\n![](linear-recovery-random-variable_files/figure-html/unnamed-chunk-5-1.png){width=528}\n:::\n:::\n\n\n\n\nwith an RMSE of 0.005. The fit is basically the same for all values of `r`. \n\n::: {.callout-important}\n## Summary\n\nThe exponential recovery equation is a good approximation of the average recovery over time when the rate of recovery is a random variable following a gamma distribution. The approximation is not as good when the rate of recovery is a random variable following an exponential distribution.\n\n:::\n\n## Conversion of parameters\n\n::: {.callout-note}\n## Optional\n\nThe section below is not directly relevant to our project, but I found the results quite fascinating. Feel free to skip it if you are not interested in the relationship between the parameters of the gamma distribution and the true recovery rate.\n:::\n\nWhen the rate of recovery is a random variable following a gamma distribution, this is approximated well by the exponential recovery equation. The gamma distribution has two parameters: the shape parameter $\\alpha$ and the rate parameter $\\lambda$, while the exponential recovery equation has only one parameter: the rate of recovery `r`. How do the parameters of the gamma distribution relate to the recovery rate in exponential recovery equation?\n\nI will simulate the recovery over time for different values of the true recovery rate `r` in the range [0.1, 5]. Then I will fit to this the marginal recovery predicted by a linear recovery process where the rate follows a gamma distribution. I will then explore the relationship between the parameters of the gamma distribution and the true recovery rate.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nt <- seq(0, 200, length.out = 10000)\nget_pars <- function(true_r, t) {\n  objective_fn <- function(pars, t, target) {\n    pred <- marginal_recovery_gamma(exp(pars[1]), exp(pars[2]), t)\n    sqrt(mean((pred - target)^2))\n  }\n\n  fit <- optim(c(0, 0), objective_fn, t = t, target = exp_recovery(true_r, t))\n\n  pars <- exp(fit$par)\n  pars\n}\n\ntrue_r <- seq(0.1, 5, length.out = 100)\npars <- run_or_load(sapply(true_r, get_pars, t = t), \"output/gamma_recovery_pars.rds\")\n\npar(mfrow = c(1, 2))\nplot(true_r, pars[1, ], type = \"l\", col = \"blue\", xlab = \"Exponential recovery rate (r)\", ylab = \"alpha\")\nplot(true_r, pars[2, ], type = \"l\", col = \"red\", xlab = \"Exponential recovery rate (r)\", ylab = \"lambda\")\n```\n\n::: {.cell-output-display}\n![](linear-recovery-random-variable_files/figure-html/unnamed-chunk-6-1.png){width=768}\n:::\n:::\n\n\n\n\nI did not expect this. The shape parameter $\\alpha$ is fixed at 2.7937 and only the rate $\\lambda$ changes. Turns out that lambda is linearly related to 1/r (red line is the \"data\" and blue line is the fitted line from a linear regression):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(1, 1), lwd = 3)\nplot(1 / true_r, pars[2, ], type = \"l\", col = \"red\", xlab = \"1 / r\", ylab = \"lambda\")\nlines(pars[2, ] ~ I(1 / true_r), col = \"blue\", lty = 4)\n```\n\n::: {.cell-output-display}\n![](linear-recovery-random-variable_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\nwith the following relationship:\n\n$$\n\\lambda \\approxeq 3.831 \\,r^{-1}\n$$\n\n## Summary\n\nAn exponential recovery processes with rate $r$ can be approximated well by a linear recovery process where the rate of recovery is a random variable which follows a gamma distribution with shape parameter $\\alpha =$ 2.794 and rate parameter $\\lambda = 3.831 \\,r^{-1}$. That is, modeling resource recovery with the following two equations is almost equivalent:\n\n$$\nR(t) = 1 - e^{-r t}\n$$\n\nand\n\n$$\nR(t) = min(1, r_{linear}t) \\\\\n$$\n\n$$\nr_{linear} \\sim \\text{Gamma}(2.794, 3.831 \\cdot r^{-1})\n$$\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}